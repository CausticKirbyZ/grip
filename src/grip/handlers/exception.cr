module Grip
  module Handlers
    class Exception
      include HTTP::Handler

      INSTANCE = new

      def call(context : HTTP::Server::Context)
        call_next(context)
      rescue ex
        case ex
        when Grip::Exceptions::Base
          call_exception_with_status_code(context, ex, ex.status_code)
        when ::Exception
          STDOUT.print("\n#{ex.inspect_with_backtrace}")
          STDOUT.flush

          return call_exception_with_status_code(context, ex, context.response.status_code) if Grip.config.error_handlers.has_key?(context.response.status_code)

          context.response.status_code = 500

          context.response.print(
            <<-HTML
              <!DOCTYPE html>
                <html>
                <head>
                  <title>
                    An exception occured at `#{context.request.path}`.
                  </title>
                  <style type="text/css">

                  </style>
                </head>
                <body>
                  <img alt="" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoKPHN2ZwogICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiCiAgIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyIKICAgeG1sbnM6c3ZnPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5ldC9EVEQvc29kaXBvZGktMC5kdGQiCiAgIHhtbG5zOmlua3NjYXBlPSJodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy9uYW1lc3BhY2VzL2lua3NjYXBlIgogICB2ZXJzaW9uPSIxLjAiCiAgIHdpZHRoPSIyMjAiCiAgIGhlaWdodD0iMjIwIgogICBpZD0ic3ZnNDAxNDciCiAgIHNvZGlwb2RpOmRvY25hbWU9ImdyaXBlbi5zdmciCiAgIGlua3NjYXBlOnZlcnNpb249IjAuOTIuNSAoMjA2MGVjMWY5ZiwgMjAyMC0wNC0wOCkiCiAgIGlua3NjYXBlOmV4cG9ydC1maWxlbmFtZT0iL2hvbWUvanJlaS9Eb3dubG9hZHMvZ3JpcGVuLnBuZyIKICAgaW5rc2NhcGU6ZXhwb3J0LXhkcGk9IjQwNSIKICAgaW5rc2NhcGU6ZXhwb3J0LXlkcGk9IjQwNSI+CiAgPHNvZGlwb2RpOm5hbWVkdmlldwogICAgIHBhZ2Vjb2xvcj0iI2ZmZmZmZiIKICAgICBib3JkZXJjb2xvcj0iIzY2NjY2NiIKICAgICBib3JkZXJvcGFjaXR5PSIxIgogICAgIG9iamVjdHRvbGVyYW5jZT0iMTAiCiAgICAgZ3JpZHRvbGVyYW5jZT0iMTAiCiAgICAgZ3VpZGV0b2xlcmFuY2U9IjEwIgogICAgIGlua3NjYXBlOnBhZ2VvcGFjaXR5PSIwIgogICAgIGlua3NjYXBlOnBhZ2VzaGFkb3c9IjIiCiAgICAgaW5rc2NhcGU6d2luZG93LXdpZHRoPSIxODcyIgogICAgIGlua3NjYXBlOndpbmRvdy1oZWlnaHQ9IjEwNDMiCiAgICAgaWQ9Im5hbWVkdmlldzI5MTEiCiAgICAgc2hvd2dyaWQ9ImZhbHNlIgogICAgIGlua3NjYXBlOnpvb209IjIuMDA3NTQ1NCIKICAgICBpbmtzY2FwZTpjeD0iLTM0LjgyNzA5OSIKICAgICBpbmtzY2FwZTpjeT0iMTAxLjk2Mzg3IgogICAgIGlua3NjYXBlOndpbmRvdy14PSI0OCIKICAgICBpbmtzY2FwZTp3aW5kb3cteT0iMCIKICAgICBpbmtzY2FwZTp3aW5kb3ctbWF4aW1pemVkPSIxIgogICAgIGlua3NjYXBlOmN1cnJlbnQtbGF5ZXI9IkF2c2xpdGV0LUdyaXBodXZ1ZCIgLz4KICA8ZGVmcwogICAgIGlkPSJkZWZzNDAxNDkiIC8+CiAgPG1ldGFkYXRhCiAgICAgaWQ9Im1ldGFkYXRhMTg4MCI+CiAgICA8cmRmOlJERj4KICAgICAgPGNjOldvcmsKICAgICAgICAgcmRmOmFib3V0PSIiPgogICAgICAgIDxkYzp0aXRsZT5Ta2Fuc2thIGRyYWdvbnJlZ2VtZW50ZXQgdmFwZW48L2RjOnRpdGxlPgogICAgICAgIDxkYzpkYXRlPjIwMDktMDEtMTQ8L2RjOmRhdGU+CiAgICAgICAgPGRjOmNyZWF0b3I+CiAgICAgICAgICA8Y2M6QWdlbnQ+CiAgICAgICAgICAgIDxkYzp0aXRsZT5Mb2thbF9Qcm9maWw8L2RjOnRpdGxlPgogICAgICAgICAgPC9jYzpBZ2VudD4KICAgICAgICA8L2RjOmNyZWF0b3I+CiAgICAgICAgPGNjOmxpY2Vuc2UKICAgICAgICAgICByZGY6cmVzb3VyY2U9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LXNhLzIuNS8iIC8+CiAgICAgICAgPGRjOnJpZ2h0cz4KICAgICAgICAgIDxjYzpBZ2VudD4KICAgICAgICAgICAgPGRjOnRpdGxlPmNjLWJ5LXNhLTIuNTwvZGM6dGl0bGU+CiAgICAgICAgICA8L2NjOkFnZW50PgogICAgICAgIDwvZGM6cmlnaHRzPgogICAgICAgIDxkYzpmb3JtYXQ+aW1hZ2Uvc3ZnK3htbDwvZGM6Zm9ybWF0PgogICAgICAgIDxkYzp0eXBlCiAgICAgICAgICAgcmRmOnJlc291cmNlPSJodHRwOi8vcHVybC5vcmcvZGMvZGNtaXR5cGUvU3RpbGxJbWFnZSIgLz4KICAgICAgPC9jYzpXb3JrPgogICAgICA8Y2M6TGljZW5zZQogICAgICAgICByZGY6YWJvdXQ9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LXNhLzIuNS8iPgogICAgICAgIDxjYzpwZXJtaXRzCiAgICAgICAgICAgcmRmOnJlc291cmNlPSJodHRwOi8vd2ViLnJlc291cmNlLm9yZy9jYy9SZXByb2R1Y3Rpb24iIC8+CiAgICAgICAgPGNjOnBlcm1pdHMKICAgICAgICAgICByZGY6cmVzb3VyY2U9Imh0dHA6Ly93ZWIucmVzb3VyY2Uub3JnL2NjL0Rpc3RyaWJ1dGlvbiIgLz4KICAgICAgICA8Y2M6cmVxdWlyZXMKICAgICAgICAgICByZGY6cmVzb3VyY2U9Imh0dHA6Ly93ZWIucmVzb3VyY2Uub3JnL2NjL05vdGljZSIgLz4KICAgICAgICA8Y2M6cmVxdWlyZXMKICAgICAgICAgICByZGY6cmVzb3VyY2U9Imh0dHA6Ly93ZWIucmVzb3VyY2Uub3JnL2NjL0F0dHJpYnV0aW9uIiAvPgogICAgICAgIDxjYzpwZXJtaXRzCiAgICAgICAgICAgcmRmOnJlc291cmNlPSJodHRwOi8vd2ViLnJlc291cmNlLm9yZy9jYy9EZXJpdmF0aXZlV29ya3MiIC8+CiAgICAgICAgPGNjOnJlcXVpcmVzCiAgICAgICAgICAgcmRmOnJlc291cmNlPSJodHRwOi8vd2ViLnJlc291cmNlLm9yZy9jYy9TaGFyZUFsaWtlIiAvPgogICAgICA8L2NjOkxpY2Vuc2U+CiAgICA8L3JkZjpSREY+CiAgPC9tZXRhZGF0YT4KICA8ZwogICAgIHRyYW5zZm9ybT0ibWF0cml4KDEuMDAwMDAyLDAsMCwxLDYuNTcyMDE0OSwtNzYuOSkiCiAgICAgaWQ9IkF2c2xpdGV0LUdyaXBodXZ1ZCIKICAgICBzdHlsZT0iZmlsbDojMDAwMDAwIj4KICAgIDxwYXRoCiAgICAgICBkPSJtIDExMS40MjY4NSwyOTIuMjQ3OTUgYyAzLjc4ODAyLC01LjUyMjk5IDYuMzU4NDgsLTEyLjk3ODIgNy4wODg4MSwtMjAuNTU5OTUgMC42MTk4NiwtNi40MzQ5MiAwLjA5MjQsLTExLjcyMDMgLTMuNTQ2OTUsLTM1LjU0MjU3IC0xLjE3NTg3LC03LjY5Njk2IC0wLjUwNDQ0LC0xOS42OTgwNSAxLjQ3MzkzLC0yNi4zNDQ2NiAxLjM2MTQsLTQuNTczOCAwLjk5ODQ0LC0yMC42NzUyNiAtMC40NjYwNiwtMjAuNjc1MjYgLTAuNDMyNjEsMCAtMi4wOTI0LDEuMjI0OTkgLTMuNjg4NDIsMi43MjIyMSAtMS41OTYwMSwxLjQ5NzIxIC00LjQ4MjgyLDMuODM1ODMgLTYuNDE1MTIsNS4xOTY5NCAtMTIuNDEzMDU2LDIwLjQzNDY5IC0xMS4wOTc0MzYsMjcuMjMzMTcgLTEwLjMzMjY2Niw0Mi45NDIwNCAwLjI4NzcxLDEwLjcxMDk0IDMuNjIxNTc3LDEzLjk5NTA4IDYuNjI2NjU2LDIxLjg5NTk0IDQuNTI4MjgsMTEuOTA1NiA2LjUzOTYxLDI1Ljc5MTk0IDQuNjkxODQsMzIuMzkyNjIgLTEuMDU0ODEsMy43NjgwNyAxLjMxNDI4LDIuNzE2NjQgNC41Njc5OCwtMi4wMjczMSB6IgogICAgICAgaWQ9InBhdGgxOTU1IgogICAgICAgaW5rc2NhcGU6Y29ubmVjdG9yLWN1cnZhdHVyZT0iMCIKICAgICAgIHNvZGlwb2RpOm5vZGV0eXBlcz0ic3Nzc3NzY2NjY3MiCiAgICAgICBzdHlsZT0iZmlsbDojZmY5YjAwIiAvPgogICAgPHBhdGgKICAgICAgIGQ9Im0gNzIuNTU2MzI5LDI4Ny44NjczMyBjIDguODU2NTI1LC02Ljc4ODA3IDE0LjU4NzU2NSwtMTkuNzcyOSAxNi43MTE1NTUsLTM3Ljg2MzQgMS42MTc2MywtMTMuNzc3NjQgMy45NTYyNSwtMjguMzMwMTggNC45MzE0LC0zMC42ODY2OCAxLjczNzM1LC00LjE5ODM1IDUuNzcxODE3LC0xNy44Mzg2OCA1LjM5Mjk4NywtMTguMjMzNDIgLTAuODA0ODYsLTAuODM4NjQgLTEwLjg3OTEyNyw0LjQ2ODY4IC0xNC4zMDA5NDcsNy41MzQwNCAtNC4xMTUyMjcsMy42ODY1MiAtMTAuODk5OTAyLDE3LjI4NDk2IC0xMy43NDMxODEsMjcuNTQ1MjggLTIuMzY1NjI2LDguNTM2NjQgLTMuMTg1MTc5LDE3LjQwMzQ5IC0zLjM4MzY1MiwzNi42MDgzMSAtMC4wODQ0MSw4LjE2NjYyIC0wLjUzMzY4MSwxNS42Mjc5NCAtMC45OTgzOTYsMTYuNTgwNzEgLTEuMzAwMTc1LDIuNjY1NjQgMC42OTA0NywyLjExNzI4IDUuMzkwMjM0LC0xLjQ4NDg0IHoiCiAgICAgICBpZD0icGF0aDE5NTMiCiAgICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIgogICAgICAgc3R5bGU9ImZpbGw6I2ZmNTQwMCIgLz4KICAgIDxwYXRoCiAgICAgICBkPSJtIDE0Ni43MTQzLDI4OC4yNjgyMyBjIDAsLTAuNDYwMDcgLTAuODYyMDEsLTEuNjE2NTkgLTEuOTE1NTcsLTIuNTcwMDQgLTkuODU3NzUsLTEyLjk0OTk4IC05LjM3MzksLTMwLjE5NzEgLTkuNDM4NDQsLTM5LjY1Mzg0IDAuMzMzMywtMjguMzg2MDkgLTcuODIxMjUsLTIxLjE3MDkxIC0xMy40NTU0OCwtMzEuNzI3OTMgLTQuNjMxNzEsLTkuNTc3NjYgLTQuNjI5MjYsLTUuNTgzMjggLTUuNTcwOSw2LjYyNzYxIC0wLjYxNDYxLDcuOTcwMTQgMi4yNTEzMywzMC42MjkxNCA1LjE4NDM0LDQwLjk4ODk3IDIuMjk5NzIsOC4xMjI5NSA3LjA3NjU0LDE1Ljg4MDU4IDEyLjYzNjE0LDIwLjUyMTI3IDYuNTYzMzksNS40Nzg1NyAxMi41NTk5MSw4LjI1NDM1IDEyLjU1OTkxLDUuODEzOTYgeiIKICAgICAgIGlkPSJwYXRoMTk1MSIKICAgICAgIGlua3NjYXBlOmNvbm5lY3Rvci1jdXJ2YXR1cmU9IjAiCiAgICAgICBzb2RpcG9kaTpub2RldHlwZXM9InNjY2Nzc3NzIgogICAgICAgc3R5bGU9ImZpbGw6I2ZmMzgwMCIgLz4KICAgIDxwYXRoCiAgICAgICBkPSJtIDM2LjA2NDQ5MSwyNjcuODIyIGMgMTYuMzA2NDQ2LC05LjI5NTMgNDIuMDk3Mzk5LC0zOS40NjkyNiAzOS45OTQ0NzUsLTU4LjYxMTY0IC0wLjMxMjk5NCwtMC4zMTI5OCAtMTUuMjk1NTY5LDYuMDIyMjcgLTI0LjQ0MTE1LDEzLjE5OTU4IC0xMi40MTEzMjMsMTIuNTYwMjggLTkuMjkyODExLDMwLjAyNTYxIC0xNy40Njg1MSw0Mi4xNjY3MSAtMi44Nzc3NDksNC4yMDM5MSAtNS4yMjU3MDYsOC40MzU3IC01LjIxNzY3OCw5LjQwMzk5IDAuMDEwOTIsMS4zMTc0OSAwLjMyNzQwNywxLjEzNzc3IDEuMjU3Njg4LC0wLjcxNDIzIDAuNjgzNywtMS4zNjExIDMuMzI3NTI3LC0zLjgxMTA5IDUuODc1MTc1LC01LjQ0NDQxIHoiCiAgICAgICBpZD0icGF0aDE5NDkiCiAgICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIgogICAgICAgc29kaXBvZGk6bm9kZXR5cGVzPSJjY2Njc2NjIgogICAgICAgc3R5bGU9ImZpbGw6I2ZmOWIwMCIgLz4KICAgIDxwYXRoCiAgICAgICBkPSJtIDE3MS40NTQsMjY1LjQ4NjQzIGMgLTAuMDA0LC0wLjM0ODc1IC0xLjc2NTcyLC0xLjYzODAxIC0zLjkxNDUxLC0yLjg2NDk5IC0xMi43NjQ0LC04Ljc4MzQ5IC0xNi42NTY2MSwtMzMuNTQ4NTMgLTE4LjM3OTQ1LC00NS4yODM5OCAtMC4zMDc2MiwtMi4xNzc3NiAtMS42MjcsLTcuNTIzMTkgLTIuOTMxOTQsLTExLjg3ODcxIC0xLjMwNDk0LC00LjM1NTUzIC0yLjY2Njg5LC05LjU3MzcyIC0zLjAyNjU0LC0xMS41OTU5OCAtMC45MDc2MSwtNS4xMDMxNyAtMy4xMjczNCwtNi44MzcxOSAtMy45NTg1MywtMy4wOTIzIC0xLjE0MTUzLDUuMTQzMjIgLTMuNjY3ODUsMTIuNjY2NDEgLTUuNDM4ODUsMTYuMTk2NTMgLTEuNDg1MjUsMi45NjA1MSAtMS41NjMxLDMuOTMzNjMgLTAuNTE0NzgsNi40MzQzIDAuNjc5MzIsMS42MjA0NCAxLjc5MTI2LDYuMDY0NDMgMi40NzA5OCw5Ljg3NTUyIDEuNzA1NDEsOS41NjE4NCAzLjkzNDIxLDE1LjYxMDcyIDguOTQyODMsMjQuMjcwNDEgNy4xMDI5NywxMi4yODA3NSAxNi4zMzkyLDE5Ljc4OTcxIDIzLjMzNjk5LDE4Ljk3Mjc2IDEuODgxNzgsLTAuMjE5NjggMy40MTc5OSwtMC42ODQ3OSAzLjQxMzgsLTEuMDMzNTYgeiIKICAgICAgIGlkPSJwYXRoMTk0NyIKICAgICAgIGlua3NjYXBlOmNvbm5lY3Rvci1jdXJ2YXR1cmU9IjAiCiAgICAgICBzdHlsZT0iZmlsbDojZmY5YjAwIgogICAgICAgc29kaXBvZGk6bm9kZXR5cGVzPSJjY2NzY2NjY2NzY2MiIC8+CiAgICA8cGF0aAogICAgICAgZD0ibSAxODUuMzIwMTIsMjQ1LjU2ODI3IGMgMCwtMC41MzQwNyAtMS4xMTYzOSwtMS4yNTEyMyAtMi40ODA4NywtMS41OTM2OSAtMjEuMTI5NzgsLTEwLjE5ODE2IC0xNy44NDc2NywtNDcuMjQzNDkgLTI3LjYzMDM5LC01Ny43NTY4IC0xLjEzMzE0LC0xLjAyNjI3IC00LjYzMDc3LC00LjM1NTQ5IC03Ljc3MjUsLTcuMzk4MjUgLTMuMTQxNzQsLTMuMDQyNzYgLTYuMDQ3MywtNS41MzIzIC02LjQ1NjgsLTUuNTMyMyAtMS4yODQzMiwwIDAuMzI5NTYsMTIuMTg1MDggMi4xNjMzLDE2LjMzMzIzIDIuNTc1NDQsNS44MjU5MyA2LjYwODc2LDE5Ljc1MTE0IDguMTA4MDcsMjcuOTkzNDkgMi4yOTgyNCwxMi42MzQ0MiA5Ljc5Nzg0LDIyLjgzOTA5IDE5LjcxNTc1LDI2LjgyNzE2IDUuMTczNzEsMi4wODA0IDE0LjM1MzQ0LDIuODAxMjcgMTQuMzUzNDQsMS4xMjcxNiB6IgogICAgICAgaWQ9InBhdGgxOTQ1IgogICAgICAgaW5rc2NhcGU6Y29ubmVjdG9yLWN1cnZhdHVyZT0iMCIKICAgICAgIHN0eWxlPSJmaWxsOiNmZjYyMDAiCiAgICAgICBzb2RpcG9kaTpub2RldHlwZXM9InNjY2NzY3NjcyIgLz4KICAgIDxwYXRoCiAgICAgICBkPSJtIDQxLjUyNTUwMywyMzEuMTY0MzkgYyA0LjcwNjQ5NSwtOC41NDU0NiAxMC43MzU5OTIsLTEzLjUwNzk1IDIyLjQ3MjEzMywtMTguNDk1MzMgOS43NTk3NywtNC4xNDc1MiAxMC4xOTc3ODcsLTQuNDc3NyAyMS44MzgyNDgsLTE2LjQ2MTY0IDYuNTMzMjksLTYuNzI2MDggMTMuMTQwNDY3LC0xNC40MTE5OCAxNC42ODI2MTYsLTE3LjA3OTc3IDIuOTQyODIsLTUuMDkwODIgMi42NzE5MSwtNi4xNDE5NyAtMC43NjAzMTksLTIuOTUgLTEwLjY2ODYxNyw5LjEwMjkzIC0yNC43OTQ1NzMsOS44MDE3NCAtMzUuODQ1OTUzLDE1LjAyMTAxIC0yMy45MDEzMjQsOS45NDIwMiAtMjQuMzgxOTUxLDM2LjQ2ODUzIC0zNS4xMjE0MTIsNDkuODUwNTQgLTIuMTIwMTkxLDIuNjQxODkgLTIuNzI4ODQ4LDIuNTIwNDIgLTEuMDE2NTgxLDIuNTIwNDIgNi4xMTExLC0xLjg0NjQ0IDEwLjgxNDA3NywtNy4xNzk0MiAxMy43NTEyNjgsLTEyLjQwNTIzIHoiCiAgICAgICBpZD0icGF0aDE5NDMiCiAgICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIgogICAgICAgc29kaXBvZGk6bm9kZXR5cGVzPSJjY3NzY2Nzc2MiCiAgICAgICBzdHlsZT0iZmlsbDojZmYzODAwIiAvPgogICAgPHBhdGgKICAgICAgIGQ9Im0gMTM4LjU0MjYzLDE3NC4zODQ3IGMgLTAuNDU0MiwtNi42MjY3NyAtMS43MjI3MSwtMTIuMjM1NzQgLTUuNzcxMDcsLTIwLjQ0NTQzIC0yLjU5MjYxLC01LjI1NzYgLTQuODc3OTksLTcuODg2MjEgLTUuMjkzODgsLTcuODg2MjEgLTQuODIxNjksMC4xOTYzOSAtNi4yMTAyNiwxNy4xNjQ5MSAtNi45NjczNCwyNC43NTk0MyAtMi40MTEzOSwyNS41MzAyNCAtMi4yMzYyMywzMS43NjU1MyAxLjExMjMzLDM5LjU5NTcyIDIuMTAzODQsNC45MTk1NiA0LjY3LDguMzQyOTEgNS42NTU3Niw3LjczMzY4IDYuODc4NTEsLTkuMDQ1MjIgMTEuODMzMzksLTM0LjI5MjgzIDExLjI2NDIsLTQzLjc1NzE5IHoiCiAgICAgICBpZD0icGF0aDE5NDEiCiAgICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIgogICAgICAgc29kaXBvZGk6bm9kZXR5cGVzPSJjY2Njc2NjIgogICAgICAgc3R5bGU9ImZpbGw6I2ZmMzgwMCIgLz4KICAgIDxwYXRoCiAgICAgICBkPSJtIDk0LjQ0NDQwNCwyMDEuMzgwNzQgYyAxOS42NTAyNjYsLTExLjI4MzU4IDIzLjExMjMzNiwtMTQuOTcgMjQuNDU0MzA2LC0yNy40NjA1NiA2LjcwMzc5LC0zMC45NTIwOSAtOC4zMDQ0NSwtMTAuMzI1MzUgLTE2LjY4MTA2LDUuMDc2NzMgLTEuNzY2ODgsMy40MTk2NSAtNi43NDA0MjYsOS42MDcxMyAtMTIuNTE3NzQ2LDE1LjU3MzAxIC04LjkyMjQ0Nyw5LjIxMzY2IC0xMi4yNzgxMTMsMTQuMDc0NzQgLTEyLjI3ODExMywxNy43ODYyOCAwLDAuODM0MTUgMC40NDU0NTIsMS41MTY2MyAwLjk4OTg5MywxLjUxNjYzIDYuMTM3MTksLTguMzI2ODggOC41NTAxNiwtOC4yMTU4MiAxNi4wMzI3MiwtMTIuNDkyMDkgeiIKICAgICAgIGlkPSJwYXRoMTkzOSIKICAgICAgIGlua3NjYXBlOmNvbm5lY3Rvci1jdXJ2YXR1cmU9IjAiCiAgICAgICBzb2RpcG9kaTpub2RldHlwZXM9ImNjY3NzY2MiCiAgICAgICBzdHlsZT0iZmlsbDojZmY2MjAwIiAvPgogICAgPHBhdGgKICAgICAgIGQ9Im0gMTc0LjQzMTMsMTk1LjI1MDA3IGMgLTYuNjYxMTIsLTcuNTExNjEgLTEwLjg3MjY3LC0xNS44NTM4OSAtMTMuMjk1NzMsLTIyLjQ1Nzc5IC01LjA5Nzk0LC0xMy45ODI4MyAtMTAuNjc0MTEsLTI0LjIzMTk0IC0xMy4xOTExNiwtMjQuMjQ1NjIgLTYuOTA2NjIsLTMuODkzNzcgLTExLjAyNzUxLC01LjU5NjE3IC0xNi4wMDAxOSwtMTEuOTQ5OTIgLTIuOTUxMzYsLTMuNzcxMDQgLTUuNDkxMjUsLTYuNzMxMyAtNS42NDQxOSwtNi41NzgzNSAtMC45OTE3OSwwLjk5MTc4IDMuMzY1MSwxNi4xMzg3NyA2LjMwNzU4LDIxLjkyODc2IDEuOTUyODQsMy44NDI2NSA0LjU2MTU1LDkuMDA4MTkgNS43OTcxMiwxMS40Nzg5OCAyLjI5NDQ3LDQuNTg4MjYgOS4yMjA1NSwxMy4xNzE2IDEyLjcwNzc1LDE1Ljc0ODQ1IDEuMDY2NDcsMC43ODgwNiA0LjY1NzA3LDQuMTI4OTUgNy45NzkxMSw3LjQyNDIgNi45OTgxNCw2Ljk0MTcgMTUuMzM5NzEsMTEuNjQ2MTkgMTUuMzM5NzEsOC42NTEyOSB6IgogICAgICAgaWQ9InBhdGgxOTM3IgogICAgICAgaW5rc2NhcGU6Y29ubmVjdG9yLWN1cnZhdHVyZT0iMCIKICAgICAgIHN0eWxlPSJmaWxsOiNmZjYyMDAiCiAgICAgICBzb2RpcG9kaTpub2RldHlwZXM9ImNjY3Njc2Njc2MiIC8+CiAgICA8cGF0aAogICAgICAgZD0ibSAxMTEuOTQwNTYsMTYyLjU1NjI1IGMgNi40OTUwNCwtOS45MTQyNiAyMC44MTg1MiwtMjIuMDgxNDUgNi4yODUzOCwtNDUuODUwMzggLTIuNDk4MywtNC4wMjQ0NCAtMjAuMjQwNjg5LC0xOS4yMzUxMTMgLTIxLjg5OTU2NiwtMTkuMjM1MTEzIC02LjMxOTg2LDcuODA5MjAzIC0xMS4xMjgzMiwyLjYxNTA1MyAtOS42ODg4MywtMy4yOTA1NyAtMTguODE2ODYsLTIuNjI2Nzc4IC0yMi4wMTgzMDMsLTUuNTExMTc0IC0zMC41MTgyMjgsLTUuNDgwNzU0IC00LjIzNzE2OCwwLjA0MDk2IC01Ljc5MDUxNywwLjY1NDc0NSAtMTAuNTQzOTE0LDQuMTY2MjkxIC04LjYxNDk4OCw2LjM2NDI2MyAtMTAuNzM0ODY0LDE0LjM2Mjk3NiAtNi4xNTQyMDQsMjMuMjIwOTc2IDEuNzU1MDQxLDMuMzkzODggMi43NzU3NCw2LjAxNDUxIDQuOTc3MTIzLDQuMDQ1NzYgMjMuNTcwMzI4LC0yMC42MzAyMzEgNjMuNzE1OTI5LDE0LjM1MjIzIDYyLjY2MDcwOSwyNi41MzUyNyAxLjcwMjU1LDUuMDU4MjUgLTQuMjUzMjEsMjkuNTMxMTUgNC44ODE1MywxNS44ODg1MiB6IgogICAgICAgaWQ9InBhdGg1NzkyIgogICAgICAgaW5rc2NhcGU6Y29ubmVjdG9yLWN1cnZhdHVyZT0iMCIKICAgICAgIHNvZGlwb2RpOm5vZGV0eXBlcz0iY2NjY2NjY2NjYyIKICAgICAgIHN0eWxlPSJmaWxsOiNmZjliMDAiIC8+CiAgICA8cGF0aAogICAgICAgZD0ibSAxODEuMjQ1MjQsMTUwLjUxOTcxIGMgLTE2LjgwMDc5LC02LjQ2ODczIC0zMC4wMDk3OCwtMjcuNDgzODMgLTQ1LjY2ODg0LC0zNC4yMjU5IC0xMi42NzEyOSwtMC4xMjkzOCAtMjIuMDA4NjIsLTguNTUxNzkgLTE1LjU3OTI5LDAuMjk4NDYgNS45ODU1OSw4LjIzOTQxIDEwLjQ4NDM2LDE1Ljc0OTk5IDE1LjAxMDQ1LDE5LjYxNjc2IDkuNDQzMDUsMTAuMzA0MjIgMjEuNjQ5NTEsMTEuMjY0NjMgMzQuNDc0MjgsMTQuMjYzNDggNC45MjE4MSwxLjE5MDc3IDExLjc2MzQsMS4yMTk5MiAxMS43NjM0LDAuMDQ3MiB6IgogICAgICAgaWQ9InBhdGgxOTI5IgogICAgICAgaW5rc2NhcGU6Y29ubmVjdG9yLWN1cnZhdHVyZT0iMCIKICAgICAgIHN0eWxlPSJmaWxsOiNmZjYyMDAiCiAgICAgICBzb2RpcG9kaTpub2RldHlwZXM9ImNjc2NjY2MiIC8+CiAgICA8cGF0aAogICAgICAgZD0ibSAxMjUuNDA2MDMsMTEyLjg5MjEzIGMgMTQuMzg1MTksMi45MTA5NiAzNS4zNDYzMSwtMC43MjkwNSA0MS43OTIwNSwtMTMuNDYwMTEzIDAsMCAwLjQyMDY4LC0yLjM3MDQxIC0wLjkzMzQsLTEuNTc4MjUgLTQuNjMxNzQsMi43OTI1MzMgLTEzLjA0MDQzLDQuNTA0NTIzIC0xOC43ODM3LDMuODI0MzEzIC00LjM0NTksLTAuNTE0NyAtNy42Mjc3NSwtMS42ODcxNzEgLTE2LjI3MjU4LC01LjgxMzQ3MyAtMTYuNzY2NjgsLTcuNjI5NDIgLTEzLjMyNDIxLC01LjkxMDc5MiAtMTcuNzE4NTksLTguNDk5MDMgLTguMTg2MywtNC42NjU4OSAtMTYuMjc5NTM2LC03LjQ2NTA5OSAtMjYuMTY5MDg2LC05LjA1MTExNiAtOS4zODIyODgsLTEuNTA0NjY2IC0xNC40MjQ4ODIsLTAuNDI3MjY1IC0xOS4zNTk3MjUsMS45NjE2NTQgLTE4LjUzNzM5MSwxMC4xOTg1NTUgOS4xMzQ5NTMsOC4yNjA1NDcgMjYuNDAxNDk1LDEzLjE2MDM2MiAyMC41Mzc5MDYsOS44NjYzNTMgMTcuNTE3Mjg2LDE0LjA5MDU3MyAzMS4wNDM1MzYsMTkuNDU1NjQzIHoiCiAgICAgICBpZD0icGF0aDE5MjciCiAgICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIgogICAgICAgc29kaXBvZGk6bm9kZXR5cGVzPSJjY2NzY2NzY2NjYyIKICAgICAgIHN0eWxlPSJmaWxsOiNmZjM4MDAiIC8+CiAgPC9nPgo8L3N2Zz4K" />
                  <pre>
                    #{ex.inspect_with_backtrace}
                  </pre>
                </body>
              </html>
            HTML
          ) if Grip.config.env == "development"

          context
        end
      end

      private def call_exception_with_status_code(context : HTTP::Server::Context, exception : ::Exception, status_code : Int32)
        return if context.response.closed?
        if !Grip.config.error_handlers.empty? && Grip.config.error_handlers.has_key?(status_code)
          context.response.status_code = status_code
          context.exception = exception

          Grip.config.error_handlers[status_code].call(context)
        else
          context.response.content_type = "text/html" unless context.response.headers.has_key?("Content-Type")
          context.response.status_code = status_code
          context.response.print(exception.message)

          context
        end
      end
    end
  end
end
